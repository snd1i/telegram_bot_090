from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes
import json
import os

# Bot token'Ä±nÄ±zÄ± buraya yapÄ±ÅŸtÄ±rÄ±n
BOT_TOKEN = os.environ.get('BOT_TOKEN')
# KullanÄ±cÄ± verilerini saklamak iÃ§in JSON dosyasÄ±
USER_DATA_FILE = 'user_data.json'

# Mesajlar ve butonlar iÃ§in dil seÃ§enekleri
LANGUAGES = {
    'ku': {
        'name': 'KÃ¼rtÃ§e Sorani ğŸ‡¹ğŸ‡¯',
        'welcome': 'ğŸ‘‹ Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª! Ø¨Û†ØªÛ•Ú©Û•Ù…Ø§Ù† Ø¨Û•Ú©Ø§Ø±Ø¨Ù‡ÛÙ†Û• Ø¨Û† Ø¯Û•Ø³ØªÚ©Û•ÙˆØªÙ†ÛŒ Ù¾Ø±Û†Ù…Ù¾ØªÛ• Ø¨Ø§Ø´Û•Ú©Ø§Ù†.',
        'prompts_button': 'Ù¾Ø±Û†Ù…Ù¾ØªÛ•Ú©Ø§Ù† ğŸ”¥',
        'change_lang_button': 'Ø²Ù…Ø§Ù† Ø¨Ú¯Û†Ú•Û•',
        'help_button': 'ÛŒØ§Ø±Ù…Û•ØªÛŒ',
        'choose_lang': 'ğŸ‘‹ ØªÚ©Ø§ÛŒÛ• Ø²Ù…Ø§Ù†ÛÚ© Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•:',
        'lang_selected': 'âœ… Ø²Ù…Ø§Ù†ÛŒ ØªÛ† Ø¯ÛŒØ§Ø±ÛŒ Ú©Ø±Ø§!',
        'help_text': 'ÛŒØ§Ø±Ù…Û•ØªÛŒ: Ø¦Û•Ù… Ø¨Û†ØªÛ• Ù¾Ø±Û†Ù…Ù¾ØªÛ•Ú©Ø§Ù†Øª Ù¾ÛØ¯Û•Ø¯Ø§Øª...'
    },
    'en': {
        'name': 'English ğŸ‡¬ğŸ‡§',
        'welcome': 'ğŸ‘‹ Welcome! Use our bot to get great prompts.',
        'prompts_button': 'Prompts ğŸ”¥',
        'change_lang_button': 'Change Language',
        'help_button': 'Help',
        'choose_lang': 'ğŸ‘‹ Please choose a language:',
        'lang_selected': 'âœ… Your language has been set!',
        'help_text': 'Help: This bot provides you with prompts...'
    },
    'ar': {
        'name': 'Arabic ğŸ‡®ğŸ‡¶',
        'welcome': 'ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹! Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙˆØªÙ†Ø§ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØµÙˆØµ Ø±Ø§Ø¦Ø¹Ø©.',
        'prompts_button': 'Ø§Ù„Ù†ØµÙˆØµ ğŸ”¥',
        'change_lang_button': 'ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©',
        'help_button': 'Ù…Ø³Ø§Ø¹Ø¯Ø©',
        'choose_lang': 'ğŸ‘‹ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù„ØºØ©:',
        'lang_selected': 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù„ØºØªÙƒ!',
        'help_text': 'Ù…Ø³Ø§Ø¹Ø¯Ø©: Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØ²ÙˆØ¯Ùƒ Ø¨Ø§Ù„Ù†ØµÙˆØµ...'
    }
}

def load_user_data():
    """KullanÄ±cÄ± verilerini yÃ¼kle"""
    try:
        with open(USER_DATA_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
        return {}

def save_user_data(data):
    """KullanÄ±cÄ± verilerini kaydet"""
    with open(USER_DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """/start komutu iÅŸleyici"""
    user_id = str(update.effective_user.id)
    user_data = load_user_data()
    
    # KullanÄ±cÄ±yÄ± kontrol et
    if user_id not in user_data or 'lang' not in user_data[user_id]:
        # Dil seÃ§imi gÃ¶ster
        await show_language_selection(update, context)
    else:
        # HoÅŸgeldin mesajÄ± gÃ¶ster
        await show_welcome_message(update, context, user_data[user_id]['lang'])

async def show_language_selection(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Dil seÃ§imi gÃ¶ster"""
    keyboard = [
        [InlineKeyboardButton(LANGUAGES['ku']['name'], callback_data='lang_ku')],
        [InlineKeyboardButton(LANGUAGES['en']['name'], callback_data='lang_en')],
        [InlineKeyboardButton(LANGUAGES['ar']['name'], callback_data='lang_ar')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "ğŸ‘‹ Please choose a language / ØªÙƒØ§ÛŒÛ• Ø²Ù…Ø§Ù†ÛÚ© Ù‡Û•ÚµØ¨Ú˜ÛØ±Û• / Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù„ØºØ©:",
        reply_markup=reply_markup
    )

async def show_welcome_message(update: Update, context: ContextTypes.DEFAULT_TYPE, lang_code='en'):
    """HoÅŸgeldin mesajÄ± gÃ¶ster"""
    lang_data = LANGUAGES.get(lang_code, LANGUAGES['en'])
    
    keyboard = [
        [InlineKeyboardButton(lang_data['prompts_button'], url='https://t.me/PrompttAI_bot/Prompts')],
        [
            InlineKeyboardButton(lang_data['change_lang_button'], callback_data='change_lang'),
            InlineKeyboardButton(lang_data['help_button'], callback_data='help')
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        lang_data['welcome'],
        reply_markup=reply_markup
    )

async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Buton tÄ±klamalarÄ±nÄ± iÅŸle"""
    query = update.callback_query
    await query.answer()
    
    user_id = str(query.from_user.id)
    user_data = load_user_data()
    
    if query.data.startswith('lang_'):
        # Dil seÃ§imi
        lang_code = query.data.split('_')[1]
        
        # KullanÄ±cÄ± verisini kaydet
        if user_id not in user_data:
            user_data[user_id] = {}
        user_data[user_id]['lang'] = lang_code
        save_user_data(user_data)
        
        # SeÃ§ilen dilin mesajÄ±nÄ± gÃ¶ster
        lang_data = LANGUAGES.get(lang_code, LANGUAGES['en'])
        await query.edit_message_text(text=lang_data['lang_selected'])
        
        # HoÅŸgeldin mesajÄ±nÄ± gÃ¶ster
        await show_welcome_message(update, context, lang_code)
        
    elif query.data == 'change_lang':
        # Dil deÄŸiÅŸtirme
        await show_language_selection(update, context)
        
    elif query.data == 'help':
        # YardÄ±m butonu
        user_lang = user_data.get(user_id, {}).get('lang', 'en')
        lang_data = LANGUAGES.get(user_lang, LANGUAGES['en'])
        await query.message.reply_text(lang_data['help_text'])

def main():
    """Botu baÅŸlat"""
    # Token kontrolÃ¼
    if BOT_TOKEN == 'BURAYA_TOKENINIZI_YAPIÅTIRIN':
        print("âŒ LÃ¼tfen BOT_TOKEN deÄŸerini ayarlayÄ±n!")
        return
    
    # Bot uygulamasÄ±nÄ± oluÅŸtur
    application = Application.builder().token(BOT_TOKEN).build()
    
    # Komut iÅŸleyicileri
    application.add_handler(CommandHandler('start', start))
    application.add_handler(CallbackQueryHandler(button_callback))
    
    # Botu baÅŸlat
    print("ğŸ¤– Bot baÅŸlatÄ±lÄ±yor...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()
